<h1 id="cellprofiler-tutorial-3d-monolayer">CellProfiler Tutorial: 3d
monolayer</h1>
<h1 id="organizing-and-importing-images">Organizing and importing
images</h1>
<h2 id="z-stacks-as-tiffs">Z-stacks as TIFFs</h2>
<ul>
<li>This tutorial features images of human induced pluripotent stem
cells from the Allen Institute of Cell Science. More details are
available at the following link: <a
href="https://bbbc.broadinstitute.org/BBBC034">https://bbbc.broadinstitute.org/BBBC034</a>.</li>
<li>CellProfiler 3D currently only works with TIFF files. TIFF files can
be rather complicated, having hyper-stack structures with all channels
and z-planes in a single file. The acceptable CellProfiler format for
storing z-stacks is to have a separate TIFF file for each channel.</li>
<li>CellProfiler can be used to convert from other file formats to
individual TIFF files for each channel using the
<strong>SaveImages</strong> module.</li>
<li>Note that this tutorial is an advanced tutorial. We recommend
completing the Translocation tutorial in order to learn principles of
image thresholding and segmentation prior to starting this
tutorial.</li>
<li>Appropiately naming the output(s) of each CellProfiler module is
important in order to avoid confusion,especially in large and complex
pipelines. Throughout this tutorial we will suggest names for each of
the outputs, but feel free to use your own.</li>
<li>This tutorial will guide you through the creation of a complete
analysis pipeline. If you wish, you can also find a final version of a
similar pipeline in the <em>3d_monolayer_final.cppipe</em> file, which
should be in the same folder as this tutorial. To load the pipeline,
simply drag the file to the left panel on the CellProfiler window.</li>
<li>Helpful video tutorials are available on the Center for Open
Bioimage Analysis YouTube page at <a
href="https://www.youtube.com/channel/UC_id9sE-vu_i30Bd-skay7Q">https://www.youtube.com/channel/UC_id9sE-vu_i30Bd-skay7Q</a>.</li>
</ul>
<h2 id="importing-data-in-cellprofiler">Importing data in
CellProfiler</h2>
<ol type="1">
<li><p>Highlight the Images module.</p></li>
<li><p>Drag-and-drop the images you will analyze into the Images module
window.</p></li>
<li><p>Highlight the Metadata module.</p></li>
<li><p>Enter the following regular expression:</p>
<p><code>^(?P&lt;Plate&gt;.*)_xy(?P&lt;Site&gt;[0-9])_ch(?P&lt;ChannelNumber&gt;[0-9])</code></p>
<p>This regular expression will parse the filenames and organize the
data.</p></li>
<li><p>Highlight the NamesAndTypes module.</p></li>
<li><p>Assign a name to “Images matching rules”.</p></li>
<li><p>Choose “Process as 3D”</p></li>
<li><p>Populate the fields for “Relative Pixel Spacing”.</p>
<ul>
<li>You can find this information on the image metadata. Open the image
in Fiji and go to Image &gt; Show Info… (or use Ctrl + I)</li>
<li>Near the end of the metadata you will find the information for the
“Voxel size” (x,y,z). You can also record this metadata when collecting
your own images</li>
<li>For this example, the relative pixel spacing is 0.26 in x and y and
0.29 pixels in z.</li>
<li>The actual units do not matter, rather their relative proportion.
The numbers are unitless and therefore the decimal place does not
matter.</li>
</ul></li>
<li><p>Create “rule criteria” to identify an image by its color/channel.
For example, using the Metadata you just extracted
-<code>Metadata -&gt; Does -&gt; Have ChannelNumber matching -&gt; 0</code>
would match the first image.</p></li>
<li><p>Give the images “variable names” that describe the contents of
the image. For example, use the name <em>dna</em> to describe an image
stained with DAPI.</p></li>
<li><p>Add images with rulesets for the other channels in the
experiment. In this case, Channel 0 contains images of the plasma
membrane, Channel 1 contains images of mitochondria, and Channel 2
contain images of DNA. You can name them <em>origMemb</em>,
<em>origMito</em> and <em>origDNA</em>, respectively.</p></li>
</ol>
<h1 id="find-objects-nuclei">Find objects: nuclei</h1>
<h2 id="image-preparation">Image preparation</h2>
<p>Before attempting to segment the cells in the images, pre-processing
the images with filters and various image processing methods will
improve the results.</p>
<ol type="1">
<li>Add a <strong>RescaleIntensity</strong> module for the DNA channel.
Rescaling the DNA image proportionally stretches the intensity values to
the full intensity range, from 0 to 1. In this case, we find that
rescaling improves the thresholding and subsequent segmentation of
nuclei. When using rescaling in your pipelines, be careful to perform
measurements on the original images, not the rescaled images. Name the
output <em>RescaledDNA</em>.</li>
</ol>
<p><img src="images/5_RescaleIntensity.png" class="align-center"
width="700" alt="image" /></p>
<ol start="2" type="1">
<li>Add a <strong>Resize</strong> module. Processing 3D images requires
much more computation time than 2D images. Often, downsampling an image
can yield large performance gains and at the same time smooth an image
to remove noise. Final segmentation results will be minimally affected
by downsampling if the objects of interest are relatively large compared
to the pixel size. Choose a value of <em>0.5</em> for both <em>X</em>
and <em>Y</em>, this will halve each of the XY dimensions, so the
resulting image will have a quarter of the area of the original. <em>Do
not resize Z</em> (keep the factor at <em>1</em>), otherwise you will
discard images from the Z stack. Name the output
<em>ResizedDNA</em>.</li>
</ol>
<p><img src="images/6_Resize.png" class="align-center" width="700"
alt="image" /></p>
<ol start="3" type="1">
<li>Add a <strong>MedianFilter</strong> module. A median filter will
homogenize the signal within the nucleus and reduce noise in the
background. DNA is not uniformly distributed throughout the nucleus,
which can lead to holes forming in the downstream object identification.
A median filter will preserve boundaries better than other smoothing
filters such as the Gaussian filter. For the example images, choose a
filter size of <em>5</em>. This number was chosen empirically: it is
smaller than the diameter of a typical nucleus; it is small enough that
nuclei aren’t merged together, yet large enough to suppress
over-segmentation of the nuclei. Name the output
<em>MedianFiltDNA</em>.</li>
</ol>
<p><img src="images/7_MedianFilter.png" class="align-center" width="700"
alt="image" /></p>
<h2 id="segmentation">Segmentation</h2>
<p>In CellProfiler 4 (and previous versions) the
<em>IdentifyPrimaryObjects</em> module does not support 3D images. Thus,
we will have to use a different strategy to segment the nuclei.</p>
<ol type="1">
<li>Add an <strong>Threshold</strong> module. This identifies a pixel
intensity value to separate the foreground (nuclei) from the background.
Empirically, we’ve found that a two-class Otsu threshold works well for
this data. We encourage you to try other thresholding methods to compare
the outputs. Name the output <em>MaskDNA</em>.</li>
</ol>
<p><img src="images/8_Threshold.png" class="align-center" width="700"
alt="image" /></p>
<ol start="2" type="1">
<li>Add a <strong>RemoveHoles</strong> module. This module implements an
algorithm that will remove small holes within the nucleus. Any remaining
holes will contribute to over-segmentation of the nuclei. Choose a size
of <em>20</em>.</li>
</ol>
<p><img src="images/9_RemoveHoles.png" class="align-center" width="700"
alt="image" /></p>
<ol start="3" type="1">
<li>Add a <strong>Watershed</strong> module. This module implements the
watershed algorithm, which will segment the nuclei. Select a Footprint
of <em>10</em> and Downsample by <em>2</em>. Downsampling reduces
processing time and decreases noise. For more information on the
watershed algorithm refer to this helpful <a
href="https://www.mathworks.com/company/newsletters/articles/the-watershed-transform-strategies-for-image-segmentation.html">MATLAB
blog post</a>.</li>
</ol>
<p><img src="images/10_Watershed.png" class="align-center" width="700"
alt="image" /></p>
<ol start="4" type="1">
<li>Add a <strong>ResizeObjects</strong> module to return the segmented
nuclei to the size of the original image. Since the original image was
scaled down by <em>0.5</em>, it must be scaled up by <em>2</em>. The
output of this module is the nuclei we are seeking. Name the output
<em>Nuclei</em>.</li>
</ol>
<p><img src="images/11_ResizeObjects.png" class="align-center"
width="700" alt="image" /></p>
<h1 id="find-objects-cells">Find objects: cells</h1>
<p>Now that we’ve segmented the nuclei, we want to segment the cytoplasm
for each nuclei whose boundaries are defined by the membrane channel.
The membrane channel presents more of a challenge because, unlike the
nuclei, the membrane signal is variable and the boundaries are connected
together in a sort of mesh. However, we can use the location of the
nuclei we already found as 'seeds' to guide the Watershed module later
on to identify regions with cells.</p>
<h2 id="transform-nuclei-into-seeds">Transform nuclei into seeds</h2>
<ol type="1">
<li><p>We will start by shrinking the nuclei to make them more seed-like
by adding an <strong>ErodeObjects</strong> module. Use the <em>ball</em>
structuring element with a size of <em>5</em>. Select “Yes” for the
“Prevent object removal” option in order to avoid losing any nuclei.</p>
<p>We’ve found that we can achieve the best results by applying
<strong>ErodeObjects</strong> to the output of the Watershed module
rather than the resized Nuclei that are at the original size (since the
Watershed output has been downsampled, the resulting seeds from
<strong>ErodeObjects</strong> are smaller and more seed-like). So,
select the <em>downsizedNuclei</em> object as input. Name the output
<em>erodedDownsizedNuclei</em>.</p></li>
</ol>
<p><img src="images/12_ErodeObjects.png" class="align-center"
width="700" alt="image" /></p>
<ol start="2" type="1">
<li>Resize these seeds using the <strong>ResizeObjects</strong> module
with a factor of <em>2</em>. Name the output
<em>erodedResizedNuclei</em>.</li>
</ol>
<p><img src="images/13_ResizeObjects.png" class="align-center"
width="700" alt="image" /></p>
<ol start="3" type="1">
<li>Next convert the eroded and resized nuclei to an image using the
<strong>ConvertObjectsToImage</strong> module. Select the
<em>uint16</em> color format. This image will serve as the seeds for
segmenting the cells. Name the output <em>cellSeeds</em>.</li>
</ol>
<p><img src="images/14_ConvertObjectsToImages.png" class="align-center"
width="700" alt="image" /></p>
<h2 id="transform-the-membrane-channel-into-cytoplasm-signal">Transform
the membrane channel into cytoplasm signal</h2>
<p>The Watershed module finds objects that have bright signal, so the
cytoplasm that will define the cell volume should have bright signal.
However, this is not the case in the membrane channel; it must be
transformed into an image where the cytoplasm is bright and the
boundaries between the cells are dark. Therefore, we will invert the
membrane channel to achieve this effect.</p>
<ol type="1">
<li>Add a <strong>Threshold</strong> module and threshold the original
membrane image (<em>origMemb</em>). We find that the <em>Otsu
three-class</em> method with middle intensity pixels assigned to the
foreground works well, but feel free to try others. Name the output
<em>MembThreshold</em>.</li>
</ol>
<p><img src="images/15_Threshold.png" class="align-center" width="700"
alt="image" /></p>
<ol start="2" type="1">
<li>Add an <strong>ImageMath</strong> module. Within the ImageMath
module choose the <em>Invert</em> operation, and invert the thresholded
membrane. Name the output <em>MembInvert</em>.</li>
</ol>
<p><img src="images/16_ImageMath.png" class="align-center" width="700"
alt="image" /></p>
<ol start="3" type="1">
<li>Add a <strong>RemoveHoles</strong> module to remove the small holes
in the segmentation of the cell interior. This helps to prevent the
cells from being split during the Watershed segmentation. Choose a size
of <em>20</em>. Name the output <em>MembInvertRemoveHoles</em>.</li>
</ol>
<p><img src="images/17_RemoveHoles.png" class="align-center" width="700"
alt="image" /></p>
<ol start="4" type="1">
<li>Add another <strong>ImageMath</strong> module. Add all of the
original images together. This creates a composite image that will be
used in the following steps to define where cells are present and the
background above and below the cells. Name the output
<em>Monolayer</em>.</li>
</ol>
<p><img src="images/18_ImageMath.png" class="align-center" width="700"
alt="image" /></p>
<ol start="5" type="1">
<li>Add a <strong>Resize</strong> module to resize the Monolayer with a
<em>Resizing factor</em> of <em>0.25</em> for X and Y (keep a factor of
1.0 for Z). Downsampling the image makes processing faster and decreases
noise. Name the output <em>DownsizedMonolayer</em>.</li>
</ol>
<p><img src="images/19_Resize.png" class="align-center" width="700"
alt="image" /></p>
<ol start="6" type="1">
<li>Add a <strong>Closing</strong> module. Choose a size of <em>17</em>
to blend the signal together. The result should look like a cloud of
signal where the monolayer resides. Name the output
<em>ClosedDownsizedMonolayer</em>.</li>
</ol>
<p><img src="images/20_Closing.png" class="align-center" width="700"
alt="image" /></p>
<ol start="7" type="1">
<li>Add a <strong>Resize</strong> module to resize the closed Monolayer
back to its original size, <em>Resizing factor</em> of <em>4</em> for X
and Y (keep a factor of <em>1.0</em> for Z). Name the output
<em>ResizedClosedMonolayer</em>.</li>
</ol>
<p><img src="images/21_Resize.png" class="align-center" width="700"
alt="image" /></p>
<ol start="8" type="1">
<li><p>Add a <strong>Threshold</strong> module and threshold the
smoothed monolayer image. The idea is to end up with a 3D mask of the
region where the cells of the monolayer exist in. We found that using a
global Otsu method with three classes (middle class identified as
foreground) works well for this example. This will define what is and is
not monolayer. Name the output <em>MonolayerMask</em>.</p>
<p>Note that most of the middle planes of the stack should be completely
white (part of the monolayer), while the regions above and below are
primarily black (not part of the monolayer).</p></li>
</ol>
<p><img src="images/22_Threshold.png" class="align-center" width="700"
alt="image" /></p>
<ol start="9" type="1">
<li>Add a <strong>MaskImage</strong> module. You will use an
<em>Image</em> as a mask (the MonolayerMask image generated in the
previous step). In this case, the mask does not need to be inverted.
Note that the planes on the bottom and top of the z-stack are black in
the masked image. Name the output <em>MembMasked</em>.</li>
</ol>
<p><img src="images/23_MaskImage.png" class="align-center" width="700"
alt="image" /></p>
<ol start="10" type="1">
<li>Add an <strong>ErodeImage</strong> module. We will use this module
to erode the membrane image generated in the previous step. Eroding
using a <em>ball</em> of size <em>1</em> improves the separation between
individual cells in the Watershed segmentation (the next step). Name the
output <em>MembFinal</em>.</li>
</ol>
<p><img src="images/24_ErodeImage.png" class="align-center" width="700"
alt="image" /></p>
<ol start="11" type="1">
<li>Add a <strong>Watershed</strong> module. The input is the result of
the previous ErodeImage module, referred to here as the MembFinal.
Change the <em>Generate from</em> option to <em>Markers</em>. The
Markers will be the <em>cellSeeds</em> image, which is the output of the
ConvertObjectsToImage module. Finally, set the Mask to also be the
<em>MembFinal</em>. This will help preserve the cell boundaries. Name
the output of this module <em>Cells</em>.</li>
</ol>
<p><img src="images/25_Watershed.png" class="align-center" width="700"
alt="image" /></p>
<h1 id="making-measurements">Making measurements</h1>
<p>Now that the nuclei and cells have been segmented in this monolayer,
measurements can be made using modules from the
<strong>Measurements</strong> category.</p>
<ol type="1">
<li>Add any desired measurements modules. For example, you might choose
to <strong>MeasureObjectIntensity</strong> and/or
<strong>MeasureObjectSizeShape</strong>. When applying these
measurements, be careful to measure the original images, not rescaled
images.</li>
</ol>
<p><img src="images/26_MeasureObjectIntensity.png" class="align-center"
width="700" alt="image" /></p>
<h1 id="creating-visuals">Creating visuals</h1>
<p>Congratulations! The nuclei and cells have been segmented and
measured in this monolayer. Visuals that reveal the details of the
segmentation can be also be created within CellProfiler. The following
steps will walk you through two different options to visualize your
CellProfiler segmentations.</p>
<ol type="1">
<li>The <strong>OverlayObjects</strong> module will overlay the objects
as colored masks on the image. We recommend overlaying onto rescaled
images, which will be easier to visualize outside of CellProfiler. For
example, you can choose the <em>Nuclei</em> as the objects and the
<em>RescaledDNA</em> as your image. Name the output
<em>NucleiOverlay</em>. You can try and do the same for the cell bodies,
overlaying the <em>Cells</em> object onto a rescaled version of the
<em>origMemb</em> image. Name the output <em>CellsOverlay</em>.</li>
</ol>
<p><img src="images/28_OverlayObjects.png" class="align-center"
width="700" alt="image" /></p>
<ol start="2" type="1">
<li>You can also convert the objects to images using the
<strong>ConvertObjectsToImage</strong> module and then save the output
using <strong>SaveImages</strong>. This option will allow you to
visualize the segmentations directly in Fiji and use them as masks for
further processing.</li>
</ol>
<p><img src="images/33_ConvertObjectsToImage.png" class="align-center"
width="700" alt="image" /></p>
<h1 id="export-measurements">Export measurements</h1>
<ol type="1">
<li>Save the output of the measurements modules using
<strong>ExportToSpreadsheet</strong> or
<strong>ExportToDatabase</strong>.</li>
</ol>
<p>It’s good practice to place all export modules at the end of your
pipeline. CellProfiler automatically calculates execution times for each
module that was run before the export module. By placing your export
modules at the end of your pipeline, you will have access to module
execution times for each module in your pipeline.</p>
<p>Thank you for completing the 3d monolayer tutorial!</p>
